pipeline {
    agent any

    environment {
        CPU_THRESHOLD = "75"
        INTERVAL = "60"                 
    }

    triggers {
        cron('H */3 * * *')
    }

    stages {
        stage('Monitor CPU Usage') {
            steps {
                script {
                    
                    def monitorScript = """
                    #!/bin/bash

                    get_cpu_usage() {
                        cpu_usage=\$(top -bn1 | grep "Cpu(s)" | awk '{print \$2 + \$4}')
                        echo "\$cpu_usage"
                    }

                
                    cpu_usage=\$(get_cpu_usage)

                    if (( \$(echo "\$cpu_usage > ${CPU_THRESHOLD}" | bc -l) )); then
                        timestamp=\$(date +"%Y-%m-%d %H:%M:%S")
                        echo "\$timestamp - CPU usage: \$cpu_usage%"
                    else
                        echo "CPU usage is under the threshold of ${CPU_THRESHOLD}%"
                    fi
                    """
                    
            
                    sh monitorScript
                }
            }
        }
    }
}

